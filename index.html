<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Target Number Game</title>

  <!--
    ==============================
    CSS STYLES
    ==============================
    Visual design is unchanged from the baseline.
    Variables are used for colors and sizing consistency.
  -->
  <style>
    :root{
      --bg1:#1a6ed8; --bg2:#3fa9f5; --panel:#0f2f57;
      --num:#1f8fff; --numShadow:#0c4fa3;
      --opAdd:#2ecc71; --opSub:#f39c12; --opMul:#9b59b6; --opDiv:#e74c3c;
      --btn:#34495e; --btnShadow:#1f2d3a;
      --white:#fff;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(160deg,var(--bg1),var(--bg2));
      color:var(--white);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .container{
      width:960px;
      max-width:96vw;
      padding:18px;
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      position:relative;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .title{font-size:22px;font-weight:800;}

    .settings{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:14px;
    }

    select{
      padding:6px 8px;
      border-radius:8px;
      border:none;
      background:#224a7c;
      color:white;
    }

    select option{background:#224a7c;color:white;}

    .row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:14px;
      margin:16px 0;
      flex-wrap:wrap;
    }

    .target{
      background:#08213f;
      padding:10px 18px;
      border-radius:10px;
      font-size:30px;
      font-weight:900;
      color:#ff7676;
      min-width:90px;
      text-align:center;
    }

    .num,.op,.btn{
      border:none;
      color:white;
      font-weight:800;
      cursor:pointer;
      border-radius:16px;
      transition:transform .05s,box-shadow .05s,filter .05s;
    }

    .num{
      min-width:160px;
      padding:34px;
      font-size:44px;
      background:var(--num);
      box-shadow:0 8px var(--numShadow);
    }

    .op{
      min-width:110px;
      padding:26px;
      font-size:36px;
      box-shadow:0 7px rgba(0,0,0,.35);
    }

    .op.add{background:var(--opAdd);}    
    .op.sub{background:var(--opSub);}    
    .op.mul{background:var(--opMul);}    
    .op.div{background:var(--opDiv);}    

    .btn{
      background:var(--btn);
      padding:10px 16px;
      box-shadow:0 6px var(--btnShadow);
    }

    .num:active,.op:active,.btn:active{
      transform:translateY(4px);
      box-shadow:0 3px rgba(0,0,0,.4);
    }

    .selected{filter:brightness(1.35);}    
    .disabled{opacity:.4;pointer-events:none;}

    .solutionBox{
      margin-top:10px;
      background:rgba(0,0,0,.35);
      padding:10px;
      border-radius:8px;
      font-size:14px;
    }

    .footer{text-align:center;font-size:13px;opacity:.9;}

    .fireworks{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      pointer-events:none;
      animation:pop 2s ease-out forwards;
    }

    @keyframes pop{
      0%{opacity:0;transform:scale(.6);}    
      20%{opacity:1;transform:scale(1);}    
      100%{opacity:0;}
    }

    .summaryBox{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:22px;
      border-radius:14px;
      text-align:center;
      gap:12px;
    }
  </style>
</head>
<body>

  <!-- ==============================
       MAIN GAME LAYOUT
       ============================== -->
  <div class="container">

    <!-- Header / Settings -->
    <div class="header">
      <div class="title">Target Number Game</div>
      <div class="settings">
        <button id="newGameBtn" class="btn">New Game</button>
        Mode:
        <select id="modeSelect">
          <option value="4">4 numbers</option>
          <option value="3">3 numbers</option>
        </select>
        Max:
        <select id="maxSelect">
          <option value="99">99</option>
          <option value="50">50</option>
        </select>
        <button id="startBtn" class="btn">Start Game</button>
      </div>
    </div>

    <!-- Score / Target Display -->
    <div class="row">
      Target <div class="target" id="targetValue">--</div>
      Score <span id="score">0</span>
      Problem <span id="problems">0/10</span>
    </div>

    <!-- Operator Buttons -->
    <div class="row">
      <button class="op add" data-op="+">+</button>
      <button class="op sub" data-op="-">âˆ’</button>
      <button class="op mul" data-op="*">Ã—</button>
      <button class="op div" data-op="/">Ã·</button>
    </div>

    <!-- Number Buttons -->
    <div class="row" id="numbersRow"></div>

    <!-- Control Buttons -->
    <div class="row">
      <button id="hintBtn" class="btn disabled">Hint (1st Move)</button>
      <button id="solutionBtn" class="btn disabled">Show Solution</button>
      <button id="resetBtn" class="btn disabled">Reset</button>
      <button id="nextBtn" class="btn disabled">New Problem</button>
    </div>

    <!-- Solution Display -->
    <div id="solutionBox" class="solutionBox" style="display:none"></div>

    <div class="footer">
      Use each number once per step. Intermediate results must be integers.
    </div>
  </div>

  <!-- ==============================
       GAME LOGIC (JavaScript)
       ============================== -->
  <script>

    /* --------------------------------------------------
       Utility functions
       -------------------------------------------------- */

    // Random integer from 0..m
    const randInt = m => Math.floor(Math.random() * (m + 1));

    // Weighted number generation:
    // - Small chance of zero
    // - Avoids multiple zeros
    const weightedNumber = (existing = []) => {
      if (existing.includes(0)) return 1 + randInt(10);
      return Math.random() < 0.05 ? 0 : 1 + randInt(10);
    };

    /* --------------------------------------------------
       Global game state
       -------------------------------------------------- */

    let state = {
      mode: 4,
      max: 99,
      numbers: [],
      original: [],
      solution: [],
      target: 0,

      selection: { first: null, op: null },

      score: 0,
      problems: 0,
      moveCount: 0,
      usedHint: 0,
      solutionShown: false,
      gameStarted: false,

      totalProblems: 10,
      hintsUsed: 0,
      solutionsUsed: 0
    };

    /* --------------------------------------------------
       DOM references
       -------------------------------------------------- */

    const numbersRow  = document.getElementById('numbersRow');
    const targetEl    = document.getElementById('targetValue');
    const scoreEl     = document.getElementById('score');
    const problemsEl  = document.getElementById('problems');

    const hintBtn     = document.getElementById('hintBtn');
    const resetBtn    = document.getElementById('resetBtn');
    const solutionBtn = document.getElementById('solutionBtn');
    const solutionBox = document.getElementById('solutionBox');
    const startBtn    = document.getElementById('startBtn');
    const nextBtn     = document.getElementById('nextBtn');

    const modeSelect  = document.getElementById('modeSelect');
    const maxSelect   = document.getElementById('maxSelect');
    const newGameBtn  = document.getElementById('newGameBtn');

    /* --------------------------------------------------
       Solver (recursive backtracking)
       Finds *one* valid solution sequence
       -------------------------------------------------- */

    function solve(nums, target) {
      if (nums.length === 1) {
        return nums[0] === target ? [] : null;
      }

      for (let i = 0; i < nums.length; i++) {
        for (let j = 0; j < nums.length; j++) {
          if (i === j) continue;

          const a = nums[i];
          const b = nums[j];
          const rest = nums.filter((_, k) => k !== i && k !== j);

         const ops = [
  { v: a + b, op: '+', ai: i, bi: j },
  { v: a * b, op: '*', ai: i, bi: j },
  { v: a - b, op: '-', ai: i, bi: j },
  { v: b - a, op: '-', ai: j, bi: i }
];

        if (b !== 0 && a % b === 0)
  ops.push({ v: a / b, op: '/', ai: i, bi: j });

if (a !== 0 && b % a === 0)
  ops.push({ v: b / a, op: '/', ai: j, bi: i });

          for (const o of ops) {
            if (!Number.isInteger(o.v)) continue;
            const r = solve([o.v, ...rest], target);
           if (r) return [{ a, b, op: o.op, result: o.v }, ...r];
          }
        }
      }
      return null;
    }

    /* --------------------------------------------------
       Problem generation
       -------------------------------------------------- */

    function generateProblem() {
      solutionBox.style.display = 'none';

      state.numbers = [];
      state.selection = { first: null, op: null };
      state.moveCount = 0;
      state.usedHint = 0;
      state.solutionShown = false;

      let nums = [];
      for (let i = 0; i < state.mode; i++) nums.push(weightedNumber(nums));

      let t, sol = null;
      for (let tries = 0; tries < 60; tries++) {
        t = randInt(state.max);
        if (nums.includes(t)) continue;
        sol = solve([...nums], t);
        if (sol) break;
      }

      if (!sol) return generateProblem();

      state.numbers  = nums.slice();
      state.original = nums.slice();
      state.target   = t;
      state.solution = sol;

      if (state.gameStarted) {
        targetEl.textContent = state.target;
        renderNumbers();
        hintBtn.classList.remove('disabled');
        resetBtn.classList.remove('disabled');
        solutionBtn.classList.remove('disabled');
      } else {
        targetEl.textContent = '--';
        renderNumbers(true);
        hintBtn.classList.add('disabled');
        resetBtn.classList.add('disabled');
        solutionBtn.classList.add('disabled');
        startBtn.classList.remove('disabled');
      }
    }

    /* --------------------------------------------------
       Rendering helpers
       -------------------------------------------------- */

    function renderNumbers(hidden = false) {
      numbersRow.innerHTML = '';

      state.numbers.forEach((n, i) => {
        const b = document.createElement('button');
        b.className = 'num';
        b.textContent = hidden ? '?' : n;
        b.onclick = () => numberClick(i, b);
        numbersRow.appendChild(b);
      });
    }

    function clearHighlights() {
      document.querySelectorAll('.selected')
        .forEach(b => b.classList.remove('selected'));
    }

    function resetSelection() {
      state.selection = { first: null, op: null };
      clearHighlights();
    }

    /* --------------------------------------------------
       Operator selection
       -------------------------------------------------- */

    document.querySelectorAll('.op').forEach(b => {
      b.onclick = () => {
        if (state.selection.first === null ||
            state.solutionShown ||
            !state.gameStarted) return;

        clearHighlights();
        b.classList.add('selected');
        state.selection.op = b.dataset.op;
        numbersRow.children[state.selection.first]
          ?.classList.add('selected');
      };
    });

    /* --------------------------------------------------
       Number click logic
       -------------------------------------------------- */

    function numberClick(i, btn) {
  if (state.solutionShown || !state.gameStarted) return;

  const s = state.selection;

  // Deselect if clicking the same number again before choosing operator
  if (s.first === i && s.op === null) {
    resetSelection();
    return;
  }

  // First number selection
  if (s.first === null) {
    s.first = i;
    btn.classList.add('selected');
    return;
  }

  // Must have operator and second number, and can't select the same number twice
  if (s.op === null || i === s.first) return;

  btn.classList.add('selected');

  const a = state.numbers[s.first];
  const b = state.numbers[i];

  // Division must be exact
  if (s.op === '/' && (b === 0 || a % b !== 0)) return;

  // Compute result
  const res = eval(`${a}${s.op}${b}`);

  // Replace the two numbers in the array with the result
  const newNumbers = [];
  state.numbers.forEach((num, idx) => {
    if (idx !== s.first && idx !== i) newNumbers.push(num);
  });
  newNumbers.unshift(res); // add result at the start
  state.numbers = newNumbers;

  renderNumbers();
  resetSelection();

  // Check end of problem
  if (state.numbers.length === 1) {
    nextBtn.classList.remove('disabled');
  }
}

    /* --------------------------------------------------
       Effects
       -------------------------------------------------- */

    function fireworks() {
      const f = document.createElement('div');
      f.className = 'fireworks';
      f.textContent = 'ðŸŽ†ðŸŽ‡âœ¨';
      document.querySelector('.container').appendChild(f);
      setTimeout(() => f.remove(), 2000);
    }

    /* --------------------------------------------------
       Hint logic (first move only)
       -------------------------------------------------- */

    hintBtn.onclick = () => {
  if (state.moveCount > 0 || state.solutionShown) return;

  state.usedHint++;
  state.hintsUsed++;

  const step = state.solution[0];
  let numsCopy = state.numbers.slice();

  // Determine actual indices to highlight, accounting for duplicates
  const ai = numsCopy.indexOf(step.a);
  numsCopy[ai] = null;  // mark as used
  const bi = numsCopy.indexOf(step.b);

  // Avoid negative hints: skip if operation would be negative
  if (step.op === '-' && step.a - step.b < 0) return;
  if (step.op === '/' && (step.b === 0 || step.a % step.b !== 0)) return;

  let d = 0;
  [
    () => highlightNum(ai),
    () => highlightOp(step.op),
    () => highlightNum(bi),
    clearHighlights
  ].forEach(fn => setTimeout(fn, d += 500));
};

    function highlightNum(i) {
      clearHighlights();
      numbersRow.children[i]?.classList.add('selected');
    }

    function highlightOp(op) {
      clearHighlights();
      document.querySelector(`.op[data-op="${op}"]`)
        ?.classList.add('selected');
    }

    /* --------------------------------------------------
       Show full solution
       -------------------------------------------------- */

    solutionBtn.onclick = () => {
  if (state.solutionShown) return;

  state.solutionShown = true;
  state.solutionsUsed++;

  hintBtn.classList.add('disabled');
  resetBtn.classList.add('disabled');
  solutionBtn.classList.add('disabled');
  nextBtn.classList.remove('disabled');

  let nums = state.original.slice();
  const steps = [];

  state.solution.forEach(s => {
    let a = nums[s.ai];
    let b = nums[s.bi];
    let result;

    // Compute result but force non-negative display if possible
    switch(s.op){
      case '+': result = a + b; break;
      case '-': result = Math.max(a - b, 0); break;  // suppress negatives
      case '*': result = a * b; break;
      case '/': result = a >= b ? Math.floor(a / b) : Math.floor(b / a); break;
    }

    const sym = s.op === '*' ? 'Ã—' : s.op === '/' ? 'Ã·' : s.op;
    steps.push(`${a} ${sym} ${b} = ${result}`);

    // Remove used numbers
    nums = nums.filter((_, i) => i !== s.ai && i !== s.bi);
    nums.unshift(result);
  });

  solutionBox.innerHTML = `<b>One valid solution:</b> ${steps.join('; ')}`;
  solutionBox.style.display = 'block';
};

    /* --------------------------------------------------
       Reset current problem
       -------------------------------------------------- */

    resetBtn.onclick = () => {
      if (state.solutionShown) return;

      state.numbers = state.original.slice();
      state.moveCount = 0;
      state.usedHint = 0;

      renderNumbers();
      resetSelection();
      hintBtn.classList.remove('disabled');
    };

    /* --------------------------------------------------
       Start / progression
       -------------------------------------------------- */

    startBtn.onclick = () => {
      startBtn.classList.add('disabled');
      targetEl.textContent = state.target;

      renderNumbers();

      hintBtn.classList.remove('disabled');
      resetBtn.classList.remove('disabled');
      solutionBtn.classList.remove('disabled');

      state.gameStarted = true;
      modeSelect.disabled = true;
      maxSelect.disabled = true;
    };
    
nextBtn.onclick = () => {
  // Prevent advancing past last problem
  if (state.problems >= state.totalProblems) {
    alert('Game over');
    return;
  }

  state.problems++;
  problemsEl.textContent = `${state.problems}/${state.totalProblems}`;

  generateProblem();
};

    function nextProblem() {
  if (state.problems >= state.totalProblems) {
    showSummary();
    return;
  }

  state.problems++;
  problemsEl.textContent = `${state.problems}/${state.totalProblems}`;
  generateProblem();
}

    /* --------------------------------------------------
       End-of-game summary
       -------------------------------------------------- */

    function showSummary() {
      const summary = document.createElement('div');
      summary.className = 'summaryBox';

      summary.innerHTML = `
        <b>Game Over</b><br>
        Final Score: ${state.score}<br>
        Correct: ${state.score > 0 ? state.problems : '0'}/10<br>
        Hints Used: ${state.hintsUsed}<br>
        Solutions Used: ${state.solutionsUsed}<br>
        <button class="btn" id="restartBtn">New Game</button>
      `;

      document.querySelector('.container').appendChild(summary);

      document.getElementById('restartBtn').onclick = () => {
        summary.remove();
        resetGame();
      };
    }

    /* --------------------------------------------------
       Full game reset
       -------------------------------------------------- */

    function resetGame() {
      state = {
        ...state,
        score: 0,
        problems: 0,
        moveCount: 0,
        usedHint: 0,
        solutionShown: false,
        gameStarted: false,
        hintsUsed: 0,
        solutionsUsed: 0
      };

      scoreEl.textContent = '0';
      problemsEl.textContent = '0/10';

      modeSelect.disabled = false;
      maxSelect.disabled = false;

      generateProblem();
    }

    /* --------------------------------------------------
       Settings & initialization
       -------------------------------------------------- */

    newGameBtn.onclick = resetGame;
    modeSelect.onchange = e => { state.mode = +e.target.value; };
    maxSelect.onchange  = e => { state.max  = +e.target.value; };

    // Initial problem on load
    generateProblem();

  </script>
</body>
</html>
